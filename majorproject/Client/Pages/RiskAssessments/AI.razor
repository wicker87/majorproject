@page "/assessments/{id:int}/ai"
@inject HttpClient _client
@inject IJSRuntime js

<AssessmentNavMenu AssessmentId="@id" />
<h3 class="card-title">Preliminary Risk Assessment Generator</h3>
<hr />

<h5>This page allows users to upload images related to a work activity and automatically generates a preliminary<br />
risk assessment form using generative AI. Users can then manually review and adjust the generated assessment.</h5>
<br />
<InputFile class="form-control" style="width:400px; max-height:300px;" OnChange="HandleFileSelected" multiple />
<p style="color:red">* Can only accept up to 3 images per generate.</p>

@if (uploadedFiles != null && uploadedFiles.Any())
{
    <div class="mt-3">
        <h5>Image Details:</h5>
        <div class="d-flex flex-row">
            @foreach (var file in uploadedFiles)
            {
                <div class="p-2">
                    <img src="@file.Base64String" alt="Uploaded Image" class="img-thumbnail" />
                    <p><strong>Name:</strong> @file.Name</p>
                    <p><strong>Type:</strong> @file.Type</p>
                    <p><strong>Size:</strong> @Math.Round(file.Size / 1024.0, 2) kB</p>
                </div>
            }
        </div>
        <br />
        <button class="btn btn-success btn-block" @onclick="UploadPicture">Generate</button>
    </div>
}

@code {

    [Parameter] public int id { get; set; }
    RiskAssessment? assessment = new RiskAssessment();

    private List<ImageSource> uploadedFiles = new List<ImageSource>();

    protected async override Task OnParametersSetAsync()
    {
        assessment = await _client.GetFromJsonAsync<RiskAssessment>($"{Endpoints.RiskAssessmentsEndpoint}/{id}");
    }

    // private async Task OpenChatGPT()
    // {
    //     await js.InvokeVoidAsync("window.open", "https://chatgpt.com/", "_blank");
    // }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {

        uploadedFiles.Clear();
        foreach (var file in e.GetMultipleFiles(3)) // Limit to 3 files
        {
            var buffer = new byte[file.Size];
            await file.OpenReadStream().ReadAsync(buffer);

            var dataUrl = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
            uploadedFiles.Add(new ImageSource
                {
                    Name = file.Name,
                    Type = file.ContentType,
                    Size = file.Size,
                    Base64String = dataUrl
                });

        }

        // Optionally, you can perform additional actions with the file here, such as uploading it to a server
        // var buffer = new byte[uploadedFile.Size];
        // await uploadedFile.OpenReadStream().ReadAsync(buffer);
    }
    public async Task UploadPicture()
    {
        
        if (uploadedFiles != null)
        {
            int uploadedFilesLength = uploadedFiles.Count;
            foreach (var image in uploadedFiles)
            {
                await _client.PostAsJsonAsync(Endpoints.ImageSourcesEndpoint, image);
            }
            uploadedFiles.Clear();

            List<ImageSource> pictureList = new List<ImageSource>();

            pictureList = await _client.GetFromJsonAsync<List<ImageSource>>(Endpoints.ImageSourcesEndpoint);

            int pictureListLength = pictureList.Count;

            int lengthdiff = pictureListLength - uploadedFilesLength;

            for(int i=lengthdiff; i<pictureListLength; i++)
            {

                /*for(int f=0; f< ; f++)
                {
                    WorkActivity workActivity = new WorkActivity();
                    //add variables to work activity
                    List<Identification> identList = new List<Identification>();
                    identList = await _client.GetFromJsonAsync<List<Identification>>(Endpoints.IdentificationsEndpoint);
                    int identLength = 0;
                    if (identList == null)
                    {
                        identLength = 0;
                    }
                    else
                    {
                        identLength = identList.Count;
                    }
                    //find amount of added identification
                    for(int g=identLength; g<identLength+; g++)
                    {
                        Identification identification = new Identification();
                        for(int h; h< ; h++)
                        {
                            RiskEvaluation riskEvaluation = new RiskEvaluation();
                            RiskControl riskControl = new RiskControl();
                        }
                    }
                }*/

            }

                
                
                    
                
            
        }
    }
    
    
}
